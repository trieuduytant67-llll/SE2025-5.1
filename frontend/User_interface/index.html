<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR.STORE - Trải Nghiệm Mua Sắm 3D</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800&family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root { --grad: linear-gradient(135deg, #4318ff 0%, #a218ff 100%); --dark: #1b2559; --bg: #f4f7fe; }
        body { background: var(--bg); font-family: 'Plus Jakarta Sans', sans-serif; color: var(--dark); overflow-x: hidden; }
        .header-main { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-bottom: 1px solid #e9edf7; position: sticky; top: 0; z-index: 1050; }
        .navbar-brand { font-family: 'Montserrat', sans-serif; font-weight: 800; font-size: 1.8rem; letter-spacing: -1px; }
        .hero-banner { background: var(--grad); color: white; padding: 100px 0; text-align: center; clip-path: polygon(0 0, 100% 0, 100% 85%, 0% 100%); margin-bottom: -40px; }
        .category-pill { padding: 10px 24px; border-radius: 50px; background: white; font-weight: 700; cursor: pointer; transition: 0.3s; border: 1px solid #eee; white-space: nowrap; }
        .category-pill.active, .category-pill:hover { background: var(--grad); color: white; border-color: transparent; transform: translateY(-3px); }
        .product-card { border: none; border-radius: 30px; background: white; transition: 0.4s; padding: 18px; position: relative; height: 100%; }
        .product-card:hover { transform: translateY(-12px); box-shadow: 0 25px 50px rgba(67, 24, 255, 0.1); }
        .img-wrapper { width: 100%; height: 220px; background: #f8f9fa; border-radius: 24px; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; }
        .product-img { max-width: 85%; max-height: 85%; object-fit: contain; }
        .btn-quick-add { position: absolute; bottom: -8px; right: 18px; width: 48px; height: 48px; border-radius: 16px; background: var(--grad); color: white; border: none; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 16px rgba(67, 24, 255, 0.3); }
        .cart-wrapper { position: relative; cursor: pointer; }
        .cart-count { position: absolute; top: -8px; right: -10px; background: #ff5b5b; color: white; font-size: 11px; width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; font-weight: 800; }
        model-viewer { width: 100%; height: 500px; background: #f8f9fa; border-radius: 25px; }
        .cart-checkbox { width: 20px; height: 20px; border-radius: 6px; cursor: pointer; accent-color: #4318ff; }
    </style>
</head>
<body>

<header class="header-main">
    <div class="container d-flex justify-content-between align-items-center py-3">
        <a class="navbar-brand text-dark text-decoration-none" href="index.html">AR<span style="color:#4318ff">.</span>STORE</a>
        <div class="d-flex align-items-center gap-4">
            <div class="cart-wrapper" onclick="openCartModal()">
                <i class="fa-solid fa-cart-shopping fs-3"></i>
                <span id="cart-count" class="cart-count">0</span>
            </div>
            <div id="nav-auth-controls" class="d-flex gap-2"></div>
        </div>
    </div>
</header>

<section class="hero-banner">
    <div class="container">
        <h1 class="display-3 fw-bolder mb-3" style="font-family: Montserrat">Mua Sắm Thế Hệ Mới</h1>
        <p class="fs-5 opacity-75">Tương tác 3D/AR chân thực và thanh toán thông minh.</p>
    </div>
</section>

<main class="container mb-5 mt-5">
    <div class="mb-5">
        <h5 class="fw-bold mb-4 text-uppercase small text-muted">Danh mục</h5>
        <div class="d-flex gap-3 overflow-auto pb-3" id="categoryList">
            <div class="category-pill active" onclick="filterCategory('all', this)">Tất cả</div>
        </div>
    </div>
    <div class="row g-4" id="productList"></div>
</main>

<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content border-0 rounded-5 shadow-lg overflow-hidden">
            <div class="modal-body p-0">
                <div class="row g-0">
                    <div class="col-lg-7 p-4 bg-light d-flex align-items-center position-relative">
                        <model-viewer id="mainViewer" src="" ar ar-modes="webxr scene-viewer quick-look" camera-controls shadow-intensity="2" auto-rotate>
                            <button slot="ar-button" class="btn btn-primary rounded-pill px-4 py-2 position-absolute bottom-0 start-50 translate-middle-x mb-4 shadow fw-bold">XEM AR TẠI NHÀ</button>
                        </model-viewer>
                    </div>
                    <div class="col-lg-5 p-5 bg-white">
                        <button type="button" class="btn-close float-end" data-bs-dismiss="modal"></button>
                        <h2 id="p-name" class="fw-bold mb-2"></h2>
                        <h3 id="p-price" class="text-primary fw-bold mb-4 fs-2"></h3>
                        <p id="p-desc" class="text-muted mb-4 fs-6 lh-lg"></p>
                        <div id="variantArea" class="mb-4" style="display:none">
                            <label class="fw-bold small mb-2 text-uppercase text-secondary">Chọn phân loại màu sắc</label>
                            <select id="colorSelect" class="form-select border-0 bg-light p-3 rounded-4 fw-bold"></select>
                        </div>
                        <button onclick="addToCart()" class="btn btn-primary w-100 py-3 fw-bold rounded-4 shadow-lg fs-5">THÊM VÀO GIỎ HÀNG</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="cartModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content p-4 rounded-5 border-0 shadow">
            <div class="modal-header border-0 pb-0"><h4 class="fw-bold">Giỏ Hàng</h4><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body py-4" id="cartBody"></div>
            <div class="modal-footer border-0 flex-column">
                <div class="w-100 d-flex justify-content-between mb-4"><span class="fw-bold text-muted small">TỔNG THANH TOÁN:</span><span id="totalPrice" class="fw-bold text-primary fs-4">0đ</span></div>
                <button id="btnCheckout" onclick="checkout()" class="btn btn-primary w-100 py-3 fw-bold rounded-pill shadow">TIẾN HÀNH THANH TOÁN</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const API = "http://34.60.101.69/api/v1";
    let cart = JSON.parse(localStorage.getItem('ar_store_cart')) || [];
    let allProducts = [];

    async function init() {
        checkAuthStatus();
        await loadCategories();
        await loadProducts();
        updateBadge();
    }

    // --- CẬP NHẬT LOGIC AUTH: HIỂN THỊ NÚT ADMIN VÀ ĐƠN HÀNG ---
    function checkAuthStatus() {
        const token = localStorage.getItem('access_token');
        const userRaw = localStorage.getItem('user_info');
        const container = document.getElementById('nav-auth-controls');
        
        if (token) {
            let adminBtn = '';
            let ordersBtn = `<a href="orders.html" class="btn btn-outline-primary border-0 fw-bold rounded-pill px-3 me-2">Đơn hàng</a>`;

            if (userRaw) {
                try {
                    const userData = JSON.parse(userRaw);
                    const user = userData.user ? userData.user : userData;
                    // Kiểm tra nếu role là admin để hiển thị nút quản trị
                    if (user.role && user.role.toString().toLowerCase() === 'admin') {
                        adminBtn = `<a href="admin.html" class="btn btn-dark rounded-pill px-4 fw-bold shadow-sm me-2">Quản trị</a>`;
                    }
                } catch (e) { console.log("Lỗi đọc thông tin user_info"); }
            }

            container.innerHTML = `
                ${ordersBtn}
                ${adminBtn}
                <button onclick="logout()" class="btn btn-outline-danger border-0 fw-bold">Thoát</button>
            `;
        } else {
            container.innerHTML = `<a href="login.html" class="btn btn-primary rounded-pill px-4 fw-bold shadow-sm">Đăng nhập</a>`;
        }
    }

    // --- LOGIC SẢN PHẨM & VARIANT 3D ---
    async function loadCategories() {
        try {
            const res = await fetch(`${API}/categories`);
            const cats = await res.json();
            const container = document.getElementById('categoryList');
            cats.forEach(c => {
                const el = document.createElement('div'); el.className = 'category-pill'; el.innerText = c.name;
                el.onclick = () => filterCategory(c.id, el); container.appendChild(el);
            });
        } catch(e){}
    }

    async function loadProducts() {
        try {
            const res = await fetch(`${API}/products`);
            allProducts = await res.json(); renderProducts(allProducts);
        } catch(e){}
    }

    function renderProducts(list) {
        document.getElementById('productList').innerHTML = list.map(p => `
            <div class="col-6 col-md-4 col-lg-3"><div class="product-card shadow-sm">
                <div class="img-wrapper" onclick="openDetail(${p.id})">
                    <img src="${p.images?.[0]?.image_path || ''}" class="product-img">
                    <button class="btn-quick-add" onclick="event.stopPropagation(); quickAdd(${p.id})"><i class="fas fa-plus"></i></button>
                </div>
                <div class="mt-3 text-center" onclick="openDetail(${p.id})">
                    <div class="fw-bold text-dark text-truncate mb-1 small">${p.name}</div>
                    <div class="text-primary fw-bold small">${new Intl.NumberFormat('vi-VN').format(p.price)}đ</div>
                </div>
            </div></div>`).join('');
        checkAuthStatus(); // Đảm bảo trạng thái đăng nhập luôn cập nhật
    }

    async function openDetail(id) {
        const res = await fetch(`${API}/products/${id}`);
        window.activeProduct = await res.json();
        const p = window.activeProduct;
        document.getElementById('p-name').innerText = p.name;
        document.getElementById('p-price').innerText = new Intl.NumberFormat('vi-VN').format(p.price) + 'đ';
        document.getElementById('p-desc').innerText = p.description || "Khám phá 3D cực chân thực.";
        
        const viewer = document.getElementById('mainViewer');
        const colorSelect = document.getElementById('colorSelect');
        const vArea = document.getElementById('variantArea');

        if (p.ar_model) {
            viewer.src = p.ar_model.model_path;
            viewer.addEventListener('load', () => {
                const names = viewer.availableVariants;
                if (names && names.length > 0) {
                    vArea.style.display = 'block';
                    colorSelect.innerHTML = names.map(name => `<option value="${name}">${name}</option>`).join('');
                    viewer.variantName = names[0];
                } else { vArea.style.display = 'none'; }
            }, { once: true });
        }
        colorSelect.onchange = (e) => { viewer.variantName = e.target.value; };
        new bootstrap.Modal(document.getElementById('productModal')).show();
    }

    // --- LOGIC GIỎ HÀNG CHỌN LỌC & THÔNG BÁO ---
    function addWithGrouping(product, color) {
        const index = cart.findIndex(item => item.id === product.id && item.color === color);
        if (index !== -1) cart[index].quantity += 1;
        else cart.push({ id: product.id, name: product.name, price: product.price, color: color, quantity: 1, images: product.images, selected: true });
        save(product.name); // Hiển thị thông báo khi thêm giỏ hàng thành công
    }

    function quickAdd(id) { addWithGrouping(allProducts.find(x => x.id === id), 'Mặc định'); }

    function addToCart() {
        const colorSelect = document.getElementById('colorSelect');
        const color = colorSelect.options.length > 0 ? colorSelect.value : 'Mặc định';
        addWithGrouping(window.activeProduct, color);
        bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
    }

    function save(productName = null) {
        localStorage.setItem('ar_store_cart', JSON.stringify(cart));
        updateBadge();
        if (productName) {
            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: 'success',
                title: `Đã thêm ${productName} vào giỏ hàng`,
                showConfirmButton: false,
                timer: 2000,
                timerProgressBar: true
            });
        }
    }

    function renderCartUI() {
        let total = 0, selectedCount = 0;
        const body = document.getElementById('cartBody');
        if (cart.length === 0) body.innerHTML = `<p class="text-center py-5 text-muted">Giỏ hàng trống</p>`;
        else {
            body.innerHTML = cart.map((item, i) => {
                if (item.selected) { total += parseFloat(item.price) * item.quantity; selectedCount++; }
                return `<div class="d-flex align-items-center mb-4 p-2 bg-light rounded-4">
                    <input type="checkbox" class="cart-checkbox me-3" ${item.selected ? 'checked' : ''} onclick="toggleSelect(${i})">
                    <div class="d-flex align-items-center flex-grow-1 gap-3 overflow-hidden">
                        <img src="${item.images?.[0]?.image_path || ''}" width="60" height="60" class="rounded-3 shadow-sm" style="object-fit:cover">
                        <div class="overflow-hidden"><div class="fw-bold small text-truncate">${item.name}</div><div class="text-primary fw-bold small">Màu: ${item.color}</div></div>
                    </div>
                    <div class="text-end ms-2"><div class="fw-bold small">${new Intl.NumberFormat('vi-VN').format(item.price * item.quantity)}đ</div><i class="fa-solid fa-trash-can text-danger mt-2 cursor-pointer" onclick="remove(${i})"></i></div>
                </div>`;
            }).join('');
        }
        document.getElementById('totalPrice').innerText = new Intl.NumberFormat('vi-VN').format(total) + 'đ';
        const btn = document.getElementById('btnCheckout'); btn.disabled = selectedCount === 0;
        btn.innerText = selectedCount > 0 ? `TIẾN HÀNH THANH TOÁN (${selectedCount})` : "CHỌN MÓN ĐỂ THANH TOÁN";
    }

    function filterCategory(id, el) {
        document.querySelectorAll('.category-pill').forEach(p => p.classList.remove('active')); el.classList.add('active');
        renderProducts(id === 'all' ? allProducts : allProducts.filter(p => p.category_id == id));
    }

    function toggleSelect(index) { cart[index].selected = !cart[index].selected; save(); renderCartUI(); }
    function openCartModal() { renderCartUI(); new bootstrap.Modal(document.getElementById('cartModal')).show(); }
    function remove(i) { if (cart[i].quantity > 1) cart[i].quantity -= 1; else cart.splice(i, 1); save(); renderCartUI(); }
    function updateBadge() { document.getElementById('cart-count').innerText = cart.reduce((sum, item) => sum + item.quantity, 0); }

    function checkout() {
        if (cart.filter(item => item.selected).length === 0) return;
        if (localStorage.getItem('access_token')) window.location.href = 'checkout.html';
        else Swal.fire({ title: 'Yêu cầu đăng nhập', icon: 'warning', showCancelButton: true }).then(res => { if(res.isConfirmed) window.location.href = 'login.html' });
    }

    function logout() { localStorage.clear(); window.location.reload(); }
    window.onload = init;
</script>
</body>
</html>
